@using Restaurant.BLL.DTOs.OrderDTO
@model IEnumerable<OrderDTO>

@{
    ViewData["Title"] = "Orders";
}

@section Styles {
    <style>
        .table thead th {
            background: #ff6600;
            color: #fff;
            font-weight: 600;
            border: none;
        }

        .table tbody tr {
            transition: background-color 0.2s ease;
        }

            .table tbody tr:hover {
                background: #fff6ee;
            }

        .btn-primary {
            background-color: #ff6600;
            border-color: #ff6600;
        }

            .btn-primary:hover, .btn-primary:focus {
                background-color: #e65c00;
                border-color: #e65c00;
            }

        .btn-warning {
            background-color: #ff9900;
            border-color: transparent;
        }

            .btn-warning:hover, .btn-warning:focus {
                background-color: #e68a00;
            }

        .btn-danger {
            background-color: #d9534f;
            border-color: transparent;
        }

            .btn-danger:hover, .btn-danger:focus {
                background-color: #c9302c;
            }

        .btn-success {
            background-color: #28a745;
            border-color: transparent;
        }

            .btn-success:hover, .btn-success:focus {
                background-color: #218838;
            }

        .badge-status {
            padding: 0.35rem 0.65rem;
            border-radius: 0.25rem;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .badge-paid {
            background-color: #28a745;
            color: white;
        }

        .badge-pending {
            background-color: #ffc107;
            color: #212529;
        }

        .badge-unpaid {
            background-color: #dc3545;
            color: white;
        }

        .badge-refunded {
            background-color: #6c757d;
            color: white;
        }

        .badge-failed {
            background-color: #dc3545;
            color: white;
        }

        .action-buttons {
            display: flex;
            gap: 0.25rem;
            flex-wrap: wrap;
            justify-content: center;
        }

            .action-buttons .btn {
                white-space: nowrap;
            }
    </style>
}

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="mb-0" style="color: #ff6600; font-weight: 700;">
            <i class="bi bi-receipt-cutoff"></i> Orders Management
        </h1>
        <a asp-controller="Order" asp-action="Add" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Add New Order
        </a>
    </div>

    @if (TempData["Message"] != null)
    {
        var messageType = TempData["MessageType"]?.ToString() ?? "info";
        var alertClass = messageType == "success" ? "alert-success" : messageType == "error" ? "alert-danger" : "alert-info";

        <div class="alert @alertClass alert-dismissible fade show" role="alert">
            <i class="bi @(messageType == "success" ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill")"></i>
            @TempData["Message"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (Model != null && Model.Any())
    {
        <div class="card shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-bordered align-middle mb-0">
                        <thead>
                            <tr>
                                <th style="width: 50px;">#</th>
                                <th>Order ID</th>
                                <th>Customer ID</th>
                                <th>Table ID</th>
                                <th>Order Type</th>
                                <th>Status</th>
                                <th>Payment Status</th>
                                <th>Service Tax</th>
                                <th>Total</th>
                                <th>Created By</th>
                                <th>Created On</th>
                                <th class="text-center" style="min-width: 300px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @{
                                var i = 1;
                                var list = Model ?? Enumerable.Empty<OrderDTO>();
                            }
                            @foreach (var item in list)
                            {
                                <tr>
                                    <td>@(i++)</td>
                                    <td><strong>#@item.Id</strong></td>
                                    <td>@item.CustomerId</td>
                                    <td>@item.TableId</td>
                                    <td>
                                        <span class="badge bg-info text-dark">@item.OrderType</span>
                                    </td>
                                    <td>@item.Status</td>
                                    <td>
                                        @{
                                            var badgeClass = item.PaymentStatus?.ToLower() switch
                                            {
                                                "paid" => "badge-paid",
                                                "pending" => "badge-pending",
                                                "unpaid" => "badge-unpaid",
                                                "refunded" => "badge-refunded",
                                                "failed" => "badge-failed",
                                                _ => "badge-pending"
                                            };
                                        }
                                        <span class="badge badge-status @badgeClass">
                                            @(item.PaymentStatus ?? "Unknown")
                                        </span>
                                    </td>
                                    <td>$@item.ServiceTax.ToString("F2")</td>
                                    <td>
                                        <strong style="color: #28a745;">$@item.Total.ToString("F2")</strong>
                                    </td>
                                    <td>@(string.IsNullOrWhiteSpace(item.CreatedBy) ? "-" : item.CreatedBy)</td>
                                    <td>@(item.CreatedOn?.ToString("yyyy/MM/dd HH:mm") ?? "-")</td>
                                    <td>
                                        <div class="action-buttons">
                                            @* Pay Now Button - Only show if payment is not completed *@
                                            @if (item.PaymentStatus?.ToLower() != "paid" &&
                                                                                item.PaymentStatus?.ToLower() != "refunded" &&
                                                                                item.Total > 0)
                                            {
                                                <a asp-controller="Payment"
                                                   asp-action="Checkout"
                                                   asp-route-orderId="@item.Id"
                                                   asp-route-amount="@item.Total"
                                                   class="btn btn-sm btn-success"
                                                   title="Process Payment">
                                                    <i class="bi bi-credit-card-fill"></i> Pay Now
                                                </a>
                                            }
                                            else if (item.PaymentStatus?.ToLower() == "paid")
                                            {
                                                <span class="btn btn-sm btn-outline-success disabled" title="Payment Completed">
                                                    <i class="bi bi-check-circle-fill"></i> Paid
                                                </span>
                                            }

                                            <a asp-controller="Order"
                                               asp-action="Details"
                                               asp-route-id="@item.Id"
                                               class="btn btn-sm btn-secondary"
                                               title="View Details">
                                                <i class="bi bi-eye-fill"></i> Details
                                            </a>

                                            @* Only allow editing if payment is not completed *@
                                            @if (item.PaymentStatus?.ToLower() != "paid")
                                            {
                                                <a asp-controller="Order"
                                                   asp-action="Update"
                                                   asp-route-id="@item.Id"
                                                   class="btn btn-sm btn-warning"
                                                   title="Edit Order">
                                                    <i class="bi bi-pencil-square"></i> Edit
                                                </a>
                                            }

                                            @* Only allow deletion if payment is not completed *@
                                            @if (item.PaymentStatus?.ToLower() != "paid")
                                            {
                                                <a asp-controller="Order"
                                                   asp-action="Delete"
                                                   asp-route-id="@item.Id"
                                                   class="btn btn-sm btn-danger"
                                                   title="Delete Order"
                                                   onclick="return confirm('Are you sure you want to delete Order #@item.Id?');">
                                                    <i class="bi bi-trash-fill"></i> Delete
                                                </a>
                                            }
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="mt-3 text-muted">
            <small>
                <i class="bi bi-info-circle"></i>
                Showing @list.Count() order(s). Orders marked as "Paid" cannot be edited or deleted.
            </small>
        </div>
    }
    else
    {
        <div class="alert alert-info text-center py-5">
            <i class="bi bi-inbox" style="font-size: 3rem; color: #6c757d;"></i>
            <h4 class="mt-3">No Orders Found</h4>
            <p class="text-muted">Start by creating your first order.</p>
            <a asp-controller="Order" asp-action="Add" class="btn btn-primary mt-2">
                <i class="bi bi-plus-circle"></i> Create First Order
            </a>
        </div>
    }
</div>

@section Scripts {
    <script>
        // Auto-dismiss alerts after 5 seconds
        document.addEventListener('DOMContentLoaded', function() {
            const alerts = document.querySelectorAll('.alert-dismissible');
            alerts.forEach(alert => {
                setTimeout(() => {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                }, 5000);
            });
        });
    </script>
}